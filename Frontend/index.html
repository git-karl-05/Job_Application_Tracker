<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Application Tracker</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Sidebar styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 60px;
      height: 100%;
      background-color: #1e1e1e;
      border-right: 1px solid #444;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0;
      gap: 1.5rem;
    }
    .sidebar a {
      text-decoration: none;
      font-size: 24px;
      color: #fff;
      transition: color 0.2s;
    }
    .sidebar a:hover {
      color: #62b5e5;
    }
    .main-container {
      margin-left: 80px;
    }

    /* Space below buttons */
    .form-buttons.table-actions {
      margin-bottom: 1rem;
    }

    /* Sorting arrow layout */
    .sortable-header {
      display: flex;
      justify-content: space-between; /* text left, arrow right */
      align-items: center;
      cursor: pointer;
    }
    .sort-arrow {
      font-size: 12px;
      opacity: 0.7;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="main.html" title="Main Page">üè†</a>
    <a href="chat.html" title="Chatbox">üí¨</a>
  </div>

  <div class="main-container">
    <!-- Left: Form -->
    <div class="table-container">
      <form id="jobApplicationForm" enctype="multipart/form-data">
        <table class="job-form-table">
          <tbody>
            <tr><th>Company</th><td><input type="text" name="company" required /></td></tr>
            <tr><th>Application Date</th><td><input type="date" name="applicationDate" required /></td></tr>
            <tr><th>Time</th><td><input type="time" name="time" /></td></tr>
            <tr><th>Location</th><td><input type="text" name="location" required /></td></tr>
            <tr><th>Posted Date</th><td><input type="date" name="postedDate" required /></td></tr>
            <tr><th>URL</th><td><input type="text" name="url" /></td></tr>
            <tr><th>Document</th><td><input type="file" name="document" /></td></tr>
          </tbody>
        </table>

        <div class="form-buttons">
          <button type="submit" id="submitBtn">Submit</button>
          <button type="button" id="cancelEditBtn">Cancel Edit</button>
          <button type="reset">Clear</button>
        </div>
      </form>
    </div>

    <!-- Right: Saved Applications -->
    <div class="table-container">
      <h2>Saved Applications</h2>

      <div class="form-buttons table-actions">
        <button id="updateButton" disabled>Update</button>
        <button id="deleteButton" disabled>Delete</button>
      </div>

      <table class="applications-table">
        <thead>
          <tr>
            <th style="text-align:center;width:40px;">
              <input type="checkbox" id="selectAll">
            </th>
            <th><div class="sortable-header"><span>Company</span><span class="sort-arrow">‚ñæ</span></div></th>
            <th><div class="sortable-header"><span>Application Date</span><span class="sort-arrow">‚ñæ</span></div></th>
            <th><div class="sortable-header"><span>Time</span><span class="sort-arrow">‚ñæ</span></div></th>
            <th><div class="sortable-header"><span>Location</span><span class="sort-arrow">‚ñæ</span></div></th>
            <th><div class="sortable-header"><span>Posted Date</span><span class="sort-arrow">‚ñæ</span></div></th>
            <th><div class="sortable-header"><span>URL</span><span class="sort-arrow">‚ñæ</span></div></th>
            <th><div class="sortable-header"><span>Document</span><span class="sort-arrow">‚ñæ</span></div></th>
          </tr>
        </thead>
        <tbody id="applicationsTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const form = document.getElementById('jobApplicationForm');
    const tbody = document.getElementById('applicationsTableBody');
    const updateBtn = document.getElementById('updateButton');
    const deleteBtn = document.getElementById('deleteButton');
    const selectAll = document.getElementById('selectAll');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const submitBtn = document.getElementById('submitBtn');

    let editingId = null;
    let currentSort = { column: null, direction: 'asc' };

    // --- Helpers ---
    function getSelectedIds() {
      return Array.from(document.querySelectorAll('.row-checkbox:checked'))
        .map(cb => cb.dataset.id)
        .filter(id => id && id.trim().length > 0);
    }

    function updateButtonsState() {
      const ids = getSelectedIds();
      if (ids.length === 0) {
        deleteBtn.disabled = true;
        updateBtn.disabled = true;
      } else if (ids.length === 1) {
        deleteBtn.disabled = false;
        updateBtn.disabled = false;
      } else {
        deleteBtn.disabled = false;
        updateBtn.disabled = true;
      }
    }

    // --- Load applications ---
    async function loadApplications() {
      tbody.innerHTML = '<tr><td colspan="8">Loading‚Ä¶</td></tr>';
      try {
        const res = await fetch('http://localhost:8080/api/applications');
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="8">Error: ${res.status}</td></tr>`;
          return;
        }
        const apps = await res.json();
        if (!apps.length) {
          tbody.innerHTML = '<tr><td colspan="8">No applications saved yet.</td></tr>';
          return;
        }

        tbody.innerHTML = apps.map(app => `
          <tr>
            <td style="text-align:center;width:40px;">
              <input type="checkbox" class="row-checkbox" data-id="${app.id}">
            </td>
            <td>${app.company ?? ''}</td>
            <td>${app.applicationDate ?? ''}</td>
            <td>${app.time ?? ''}</td>
            <td>${app.location ?? ''}</td>
            <td>${app.postedDate ?? ''}</td>
            <td>${app.url ? `<a href="${app.url}" target="_blank">View</a>` : ''}</td>
            <td>${app.documentUrl ? `<a href="${app.documentUrl}" target="_blank">Download</a>` : ''}</td>
          </tr>
        `).join('');

        selectAll.checked = false;
        updateButtonsState();
        updateSortIndicators();
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="8">Error loading applications.</td></tr>';
      }
    }

    // --- Delete selected ---
    async function deleteSelectedIndividually() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      if (!confirm(`Delete ${ids.length} selected item(s)?`)) return;

      try {
        const results = await Promise.all(ids.map(id =>
          fetch(`http://localhost:8080/api/applications/${encodeURIComponent(id)}`, {
            method: 'DELETE'
          })
        ));
        const failures = results.filter(r => !r.ok);
        if (failures.length) {
          alert(`Some deletes failed (${failures.length}/${results.length}).`);
        }
        await loadApplications();
      } catch (err) {
        console.error(err);
        alert('Delete error: ' + err.message);
      }
    }

    // --- Sorting ---
    function sortTableByColumn(columnIndex) {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      if (!rows.length || rows[0].querySelector('td[colspan]')) return;

      const isAsc = currentSort.column === columnIndex && currentSort.direction === 'asc';
      currentSort = { column: columnIndex, direction: isAsc ? 'desc' : 'asc' };

      rows.sort((a, b) => {
        const aText = a.querySelectorAll('td')[columnIndex].textContent.trim();
        const bText = b.querySelectorAll('td')[columnIndex].textContent.trim();

        const aVal = Date.parse(aText) || parseFloat(aText) || aText.toLowerCase();
        const bVal = Date.parse(bText) || parseFloat(bText) || bText.toLowerCase();

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
      updateSortIndicators();
    }

    function updateSortIndicators() {
      document.querySelectorAll('.applications-table th').forEach((th, idx) => {
        if (idx === 0) {
          th.innerHTML = '<input type="checkbox" id="selectAll">';
        } else {
          const arrowEl = th.querySelector(".sort-arrow");
          if (!arrowEl) return;
          let arrow = '‚ñæ'; // neutral
          if (idx === currentSort.column) {
            arrow = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
          }
          arrowEl.textContent = arrow;
        }
      });

      // reattach selectAll
      document.getElementById('selectAll').addEventListener('change', () => {
        const all = document.querySelectorAll('.row-checkbox');
        all.forEach(cb => cb.checked = selectAll.checked);
        updateButtonsState();
      });
    }

    // --- Checkbox handling ---
    tbody.addEventListener('change', (e) => {
      if (e.target.classList.contains('row-checkbox')) {
        updateButtonsState();
        const all = Array.from(document.querySelectorAll('.row-checkbox'));
        selectAll.checked = all.length > 0 && all.every(cb => cb.checked);
      }
    });

    selectAll.addEventListener('change', () => {
      const all = document.querySelectorAll('.row-checkbox');
      all.forEach(cb => cb.checked = selectAll.checked);
      updateButtonsState();
    });

    deleteBtn.addEventListener('click', (e) => {
      e.preventDefault();
      deleteSelectedIndividually();
    });

    // --- Update selected ---
    updateBtn.addEventListener('click', () => {
      const ids = getSelectedIds();
      if (ids.length !== 1) return;
      const id = ids[0];
      const row = document.querySelector(`.row-checkbox[data-id="${id}"]`).closest('tr');
      const cells = row.querySelectorAll('td');

      form.company.value = cells[1].textContent;
      form.applicationDate.value = cells[2].textContent;
      form.time.value = cells[3].textContent;
      form.location.value = cells[4].textContent;
      form.postedDate.value = cells[5].textContent;
      form.url.value = cells[6].querySelector('a')?.getAttribute('href') || '';

      editingId = id;
      submitBtn.textContent = "Save Update";
    });

    cancelEditBtn.addEventListener('click', () => {
      form.reset();
      editingId = null;
      submitBtn.textContent = "Submit";
    });

    // --- Create or update ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);

      try {
        const url = editingId
          ? `http://localhost:8080/api/applications/${encodeURIComponent(editingId)}`
          : 'http://localhost:8080/api/applications';
        const method = editingId ? 'PUT' : 'POST';
        const res = await fetch(url, { method, body: fd });

        if (!res.ok) {
          alert(`${method} failed: ${res.status}`);
          return;
        }

        form.reset();
        editingId = null;
        submitBtn.textContent = "Submit";
        await loadApplications();
      } catch (err) {
        console.error(err);
        alert(`${editingId ? 'Update' : 'Create'} error: ` + err.message);
      }
    });

    // --- Init ---
    window.onload = () => {
      loadApplications();
      document.querySelectorAll('.applications-table th').forEach((th, idx) => {
        if (idx === 0) return; // skip selectAll col
        th.addEventListener('click', () => sortTableByColumn(idx));
      });
      updateSortIndicators();
    };
  </script>
</body>
</html>
